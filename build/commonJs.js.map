{"version":3,"file":"commonJs.js","sources":["../src/index.ts","../src/commonJs/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\r\n\r\n\r\nexport async function fetchText(url: string, parameter?: RequestInit): Promise<string> {\r\n\treturn fetch(url, parameter)\r\n\t\t.then(response => response.text())\r\n}\r\n\r\nexport async function fetchJSON(url: string, parameter?: RequestInit): Promise<JSON> {\r\n\treturn fetch(url, parameter)\r\n\t\t.then(response => response.json())\r\n}\r\n\r\nexport async function fetchBlob(url: string, parameter?: RequestInit): Promise<Blob> {\r\n\treturn fetch(url, parameter)\r\n\t\t.then(response => response.blob())\r\n}\r\n\r\nexport async function fetchDocument(url: string, parameter?: RequestInit): Promise<Document> {\r\n\treturn fetch(url, parameter)\r\n\t\t.then(response => response.text())\r\n\t\t.then(strHtml => new DOMParser().parseFromString(strHtml, 'text/html'))\r\n}\r\n\r\n// export async function fetchGZip(url: string, parameter?: RequestInit) {\r\n// \treturn fetch(url, parameter)\r\n// \t\t.then(response => response.blob())\r\n// \t\t.then(data => new Response(data.stream().pipeThrough( new DecompressionStream('gzip') )))\r\n// }\r\n\r\n\r\nexport async function fetchOnlyResponseOk(url: string, parameter?: RequestInit): Promise<Response> {\r\n\treturn fetch(url, parameter)\r\n\t\t.then(response => {\r\n\t\t\tif (!response.ok) throw new Error(`[HTTP ${response.status}] The response isn't ok.`)\r\n\t\t\treturn response\r\n\t\t})\r\n}\r\n\r\nexport async function fetchInTime(url: string, parameter?: RequestInit, time = 5000): Promise<Response> {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tsetTimeout(() => reject(new Error('fetch overtime')), time)\r\n\t\tfetch(url, parameter)\r\n\t\t\t.then(resolve)\r\n\t\t\t.catch(reject)\r\n\t})\r\n}\r\n\r\nexport async function fetchAutoRetry(url: string, parameter?: RequestInit, times = 5, delay = 5000): Promise<Response> {\r\n\tconst sleep = (time: number) => new Promise(resolve => setTimeout(resolve, time))\r\n\treturn fetch(url, parameter)\r\n\t\t.catch(async (error) => {\r\n\t\t\tif (times <= 0) throw error\r\n\r\n\t\t\tawait sleep(delay)\r\n\t\t\treturn fetchAutoRetry(url, parameter, --times, delay)\r\n\t\t})\r\n}\r\n\r\n\r\nexport function combineSignals(signals: Array<AbortSignal>): AbortSignal {\r\n\tconst controller = new AbortController()\r\n  \r\n\tfor (const signal of signals) {\r\n\t\tif (signal.aborted) return signal\r\n    \r\n\t\tsignal.addEventListener(\r\n\t\t\t'abort',\r\n\t\t\t() => controller.abort(signal.reason), \r\n\t\t\t{ signal: controller.signal }\r\n\t\t)\r\n\t}\r\n  \r\n\treturn controller.signal\r\n}\r\n\r\n\r\n\r\n\r\nexport interface RequestConfig extends RequestInit {\r\n\tloadingTime?: number,\r\n\tretryTimes?: number,\r\n\tretryDelay?: number,\r\n\r\n\ttypeFrom?: '',\r\n\ttypeTo?: '' | 'text' | 'json' | 'blob' | 'document',\r\n\r\n\tisBadResponseError?: boolean,\r\n\tonError?: (error: any) => void,\r\n\tcontroller?: AbortController,\r\n}\r\nasync function joFetch(url: string, config: RequestConfig = {}): Promise<Response | string | JSON | Blob | Document> {\r\n\tinterface RequestParameter extends RequestInit {\r\n\t\tloadingTime: number,\r\n\t\tretryTimes: number,\r\n\t\tretryDelay: number,\r\n\t\r\n\t\ttypeFrom: '',\r\n\t\ttypeTo: '' | 'text' | 'json' | 'blob' | 'document',\r\n\t\r\n\t\tisBadResponseError: boolean,\r\n\t\tonError: (error: any) => void,\r\n\t\tcontroller: AbortController,\r\n\t}\r\n\tconst initialize = (config: RequestConfig): RequestParameter => {\r\n\t\treturn {\r\n\t\t\tloadingTime: 10000,\r\n\t\t\tretryTimes: 5,\r\n\t\t\tretryDelay: 5000,\r\n\r\n\t\t\ttypeFrom: '',\r\n\t\t\ttypeTo: '',\r\n\r\n\t\t\tisBadResponseError: false,\r\n\t\t\tonError: ((error: any) => { throw error }),\r\n\t\t\tcontroller: new AbortController(),\r\n\r\n\t\t\t...config\r\n\t\t}\r\n\t}\r\n\r\n\tconst combineSignals = (signals: Array<AbortSignal>): AbortSignal => {\r\n\t\tconst controller = new AbortController()\r\n      \r\n\t\tfor (const signal of signals) {\r\n\t\t\tif (signal.aborted) return signal\r\n        \r\n\t\t\tsignal.addEventListener(\r\n\t\t\t\t\"abort\",\r\n\t\t\t\t() => controller.abort(signal.reason), \r\n\t\t\t\t{ signal: controller.signal }\r\n\t\t\t)\r\n\t\t}\r\n      \r\n\t\treturn controller.signal\r\n\t}\r\n\tconst fetchInTime = async (url: string, parameter: RequestParameter, time: number): Promise<Response> => {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst timeout = setTimeout(() => reject(new Error('fetch overtime')), time)\r\n\t\t\tparameter.signal = parameter.signal? combineSignals([parameter.controller.signal, parameter.signal]) : parameter.controller.signal;\r\n\t\t\tfetch(url, parameter)\r\n\t\t\t\t.then(resolve)\r\n\t\t\t\t.catch(reject)\r\n\t\t\t\t.finally(() => clearTimeout(timeout))\r\n\t\t})\r\n\t}\r\n\r\n\tconst processResponse = (response: Response) => {\r\n\t\tif (parameter.isBadResponseError && !response.ok) throw new Error(`[HTTP ${response.status}] The response isn't ok.`)\r\n\t\treturn response\r\n\t}\r\n\r\n\tconst sleep = (time: number) => new Promise(resolve => setTimeout(resolve, time))\r\n\tconst retryOnFailure = async (error: any) => {\r\n\t\tparameter.controller.abort()\r\n\t\tif (parameter.retryTimes-- <= 0) return parameter.onError(error)\r\n\r\n\t\tawait sleep(parameter.retryDelay)\r\n\t\treturn joFetch(url, parameter)\r\n\t}\r\n\r\n\tconst processDataType = (promise: Promise<any>) => {\r\n\t\tswitch (parameter.typeFrom) {\r\n\t\t// case 'gzip':\r\n\t\t// \tpromise = promise\r\n\t\t// \t\t.then(response => response.blob())\r\n\t\t// \t\t.then(data => new Response(data.stream().pipeThrough( new DecompressionStream('gzip') )))\r\n\t\t// \tbreak\r\n    \r\n\t\tcase '':\r\n\t\tdefault:\r\n\t\t\tbreak\r\n\t\t}\r\n\t\tswitch (parameter.typeTo) {\r\n\t\tcase 'text':\r\n\t\t\tpromise = promise\r\n\t\t\t\t.then(response => response.text())\r\n\t\t\tbreak\r\n    \r\n\t\tcase 'json':\r\n\t\t\tpromise = promise\r\n\t\t\t\t.then(response => response.json())\r\n\t\t\tbreak\r\n    \r\n\t\tcase 'blob':\r\n\t\t\tpromise = promise\r\n\t\t\t\t.then(response => response.blob())\r\n\t\t\tbreak\r\n    \r\n\t\tcase 'document':\r\n\t\t\tpromise = promise\r\n\t\t\t\t.then(response => response.text())\r\n\t\t\t\t.then(strHtml => new DOMParser().parseFromString(strHtml, 'text/html'))\r\n\t\t\tbreak\r\n                \r\n\t\tcase '':\r\n\t\tdefault:\r\n\t\t\tbreak\r\n\t\t}\r\n\t\treturn promise\r\n\t}\r\n\r\n\r\n\tconst parameter = initialize(config)\r\n\treturn processDataType(\r\n\t\tfetchInTime(url, parameter, parameter.loadingTime)\r\n\t\t\t.then(processResponse)\r\n\t\t\t.catch(retryOnFailure)\r\n\t)\r\n}\r\nexport default joFetch","/* eslint-disable @typescript-eslint/ban-ts-comment */\r\nimport fetch from 'node-fetch';\r\nif (typeof global.fetch === 'undefined') {\r\n\t//@ts-ignore\r\n\tglobal.fetch = fetch;\r\n}\r\n\r\nimport { JSDOM } from 'jsdom';\r\nif (typeof global.DOMParser === 'undefined') {\r\n\tglobal.DOMParser = new JSDOM().window.DOMParser;\r\n}\r\n\r\n\r\nexport * from \"../\";\r\n// Make the default export can be imported directly.\r\nimport joFetch from '../';\r\nexport default joFetch;\r\nexports = module.exports = joFetch;"],"names":["fetch","JSDOM"],"mappings":"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"}